<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>妈妈生日快乐</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container center">
    <h2>🌷 妈妈 42 岁生日快乐 🌷</h2>
    <p>第一张图片是我们一起去西藏的时候，那是我们第一次真正意义上一起旅行，其实我还想和你去更多地方，希望有机会！第二张图片是我三年级的时候我们一起做蛋糕了，那时候还是一个小人和一个大人，现在已经变成两个大人啦~我感觉现在最好了，你不要变老好不好呀~你温柔的笑容陪我走过最难的时光。愿你的每一天，都像今天一样被爱包围。希望你天天开心，少喝酒多运动！祝你早日减肥成功！！</p>

    <div class="grid">
      <img src="mom1.jpg" alt="在西藏合影" class="hero-img">
      <img src="mom2.jpg" alt="一起做蛋糕" class="hero-img">
    </div>

    <div class="panel">
      <a class="btn" href="quiz.html?for=mom">下一步 → 小小互动</a>
    </div>

    <!-- 连续播放的首发播放器（从这里或 dad.html 首次启动） -->
    <audio id="bgm" class="audio" controls src="story.mp3"></audio>
    <p class="tip">（若浏览器拦截自动播放，请点一下 ▶ ）</p>
  </div>

  <script>
    sessionStorage.setItem('who','mom');

    const KEY = 'bgmProgress';
    const STARTED = 'bgmStarted';
    const audio = document.getElementById('bgm');

    function save() {
      try {
        sessionStorage.setItem(KEY, JSON.stringify({
          t: audio.currentTime,
          playing: !audio.paused,
          src: audio.currentSrc
        }));
      } catch(e){}
    }

    async function resumeIfNeeded() {
      const s = JSON.parse(sessionStorage.getItem(KEY) || '{}');
      if (s.src === audio.currentSrc && typeof s.t === 'number') {
        audio.currentTime = Math.max(0, s.t - 0.3);
      }
      if (s.playing) {
        try { await audio.play(); } catch(e){}
      }
    }

    const timer = setInterval(save, 1000);
    window.addEventListener('beforeunload', save);
    document.addEventListener('visibilitychange', () => { if (document.hidden) save(); });

    // 关键修复：通过用户交互触发播放
    function playAudio() {
      audio.play().then(() => {
        // 播放成功后移除事件监听
        document.removeEventListener('click', playAudio);
        document.removeEventListener('touchstart', playAudio);
      }).catch(err => {
        console.log('播放需要用户交互:', err);
      });
    }
    
    // 监听任何用户交互来触发播放
    document.addEventListener('click', playAudio);
    document.addEventListener('touchstart', playAudio); // 移动端

    (async () => {
      if (!sessionStorage.getItem(STARTED)) {
        audio.volume = 0.85;
        try {
          await audio.play();
          sessionStorage.setItem(STARTED, '1');
          save();
        } catch(e){}
      } else {
        resumeIfNeeded();
      }
    })();
  </script>
</body>
</html>
