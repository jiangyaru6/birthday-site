<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>互动小问答</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container center">
    <h2>🎁 互动小问答 🎁</h2>

    <div class="q">你最希望实现的愿望是？</div>
    <div class="opts">
      <button class="opt" data-pop="💰 金币从天而降！一夜暴富~">A. 一夜暴富</button>
      <button class="opt" data-pop="🌿 我们都会好好的，当然也要养成健康的生活方式~。">B. 健康平安</button>
      <button class="opt" data-pop="🏠 我永远记得你给的温暖。">C. 家庭和睦</button>
      <button class="opt" data-pop="🌈 愿好运常伴你身边！">D. 万事顺意</button>
    </div>

    <div class="q">你打开这个网页的第一反应？</div>
    <div class="opts">
      <button class="opt" data-pop="当然是我亲自设计的！">A. 这是我宝贝做的吗？</button>
      <button class="opt" data-pop="不许哭！我还会一直给你们准备惊喜的~">B. 这么有心？眼睛有点酸…</button>
      <button class="opt" data-pop="嘿嘿，我是不是有点厉害！">C. 还带互动？</button>
      <button class="opt" data-pop="对呀，这首歌我和GPT挑了好久～">D. 还有音乐！</button>
    </div>

    <div class="q">你觉得我是什么样的小孩？</div>
    <div class="opts">
      <button class="opt" data-pop="你们的爱我都记在心上。">A. 贴心</button>
      <button class="opt" data-pop="放心，我会好好过自己的人生。">B. 有主见</button>
      <button class="opt" data-pop="是因为我在长大呀。">C. 偶尔有点叛逆</button>
      <button class="opt" data-pop="真的有人选这个选项吗，笑死我了，被你猜对了。">D. 离不开家</button>
    </div>

    <div class="q">你希望我接下来最该做的是什么？</div>
    <div class="opts">
      <button class="opt" data-pop="我知道啦！已经在学了。">A. 好好读书！</button>
      <button class="opt" data-pop="答应你，不让你们想我太久。">B. 多回家看看</button>
      <button class="opt" data-pop="求你们给我手搓一个180帅哥腹肌男！。">C. 谈个靠谱恋爱</button>
      <button class="opt" data-pop="你怎么知道我昨天又三点睡…">D. 吃饱睡好不熬夜</button>
    </div>

    <div class="panel">
      <a class="btn" id="goWish" href="wish.html">去许愿 →</a>
      <p class="tip">（到下一页会自动切换为《夜的钢琴曲》）</p>
    </div>
  </div>

<!-- ✅ 只挂一个空播放器，不设 src、不自动播放 -->
<audio id="bgm" class="audio" controls></audio>

<script>
  // —— 小彩带 & 跳转，这些保持你之前的逻辑 —— 
  const conf = ["🎉","✨","🎊","💖","💫","🌟"];
  function pop(text){
    alert(text);
    for(let i=0;i<12;i++){
      const s = document.createElement('div');
      s.className='fetti';
      s.textContent = conf[Math.floor(Math.random()*conf.length)];
      s.style.left = (10+Math.random()*80)+'%';
      s.style.fontSize = (18+Math.random()*18)+'px';
      document.body.appendChild(s);
      setTimeout(()=>s.remove(),2200);
    }
  }
  document.querySelectorAll('.opt').forEach(el=>{
    el.addEventListener('click',()=>pop(el.dataset.pop));
  });

  const who = new URLSearchParams(location.search).get('for') || sessionStorage.getItem('who') || 'dad';
  sessionStorage.setItem('who',who);
  document.getElementById('goWish').href = 'wish.html?for='+who;

  // —— 连续播放：等到元数据加载好，再定位再播放 —— 
  const KEY = 'bgmProgress';
  const audio = document.getElementById('bgm');

  function save() {
    try {
      sessionStorage.setItem(KEY, JSON.stringify({
        t: audio.currentTime,
        playing: !audio.paused,
        // 用 absolute 的 currentSrc 更稳；若没有就用 src
        src: audio.currentSrc || audio.src
      }));
    } catch(e){}
  }

  (function resume(){
    const s = JSON.parse(sessionStorage.getItem(KEY) || '{}');
    // 没存过就兜底用文件名
    const src = s && s.src ? s.src : 'a little story.mp3';

    audio.preload = 'auto';
    audio.src = src;

    // 关键：一定要等 loadedmetadata，再设 currentTime，再决定是否 play
    const seekAndMaybePlay = async () => {
      const t = (typeof s.t === 'number') ? Math.max(0, s.t - 0.25) : 0;
      try { audio.currentTime = t; } catch(e){}
      if (s.playing) {
        try { await audio.play(); } catch(e){}
      }
      // 开始定时保存
      setInterval(save, 1000);
      window.addEventListener('beforeunload', save);
      document.addEventListener('visibilitychange', () => { if (document.hidden) save(); });
    };

    if (audio.readyState >= 1) {
      // 元数据已就绪，直接定位
      seekAndMaybePlay();
    } else {
      audio.addEventListener('loadedmetadata', seekAndMaybePlay, { once: true });
    }
  })();
</script>
  
</body>
</html>
